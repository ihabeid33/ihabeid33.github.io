---
layout: post
title: Detection Engineering with Security Onion
date:
type: post
parent_id: '0'
published: false
password: ''
status: draft
categories: []
tags: []
meta:
  _last_editor_used_jetpack: block-editor
  _edit_last: '1'
  bloglo_disable_topbar: ''
  bloglo_disable_header: ''
  bloglo_disable_page_title: ''
  bloglo_disable_breadcrumbs: ''
  bloglo_disable_thumbnail: ''
  bloglo_disable_footer: ''
  bloglo_disable_copyright: ''
  bloglo_disable_blog_card_border: ''
  _g_feedback_shortcode_6605e18d34b3517df60339f4a3ffa9ff5e3bfd34: "\n\t\t\t\t[contact-field
    label=\"Name\" type=\"name\"  required=\"true\" /]\n\t\t\t\t[contact-field label=\"Email\"
    type=\"email\" required=\"true\" /]\n\t\t\t\t[contact-field label=\"Website\"
    type=\"url\" /]\n\t\t\t\t[contact-field label=\"Message\" type=\"textarea\" /]"
  _g_feedback_shortcode_atts_6605e18d34b3517df60339f4a3ffa9ff5e3bfd34: a:18:{s:2:"to";s:20:"ihabeid33@icloud.com";s:7:"subject";s:52:"[1h4b
    31d] Detection Engineering with Security Onion";s:12:"show_subject";s:2:"no";s:6:"widget";i:0;s:14:"block_template";N;s:19:"block_template_part";N;s:2:"id";i:143;s:18:"submit_button_text";s:6:"Submit";s:14:"customThankyou";s:0:"";s:21:"customThankyouHeading";s:26:"Your
    message has been sent";s:21:"customThankyouMessage";s:30:"Thank you for your submission!";s:22:"customThankyouRedirect";s:0:"";s:10:"jetpackCRM";b:1;s:9:"className";N;s:9:"postToUrl";N;s:14:"salesforceData";N;s:12:"hiddenFields";N;s:14:"stepTransition";s:10:"fade-slide";}
author:
  login: LisanAlGaib
  email: ihabeid33@icloud.com
  display_name: Ihab
  first_name: Ihab
  last_name: Eid
permalink: "/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:heading {"level":3} --><html><body></p>
<h3 class="wp-block-heading">What is a SOC?</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Elastic</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 class="wp-block-heading">Security Onion</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 class="wp-block-heading">Deploying Elastic Agents</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Firewall Rules</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Before deploying any agents, I needed to make sure that Security Onion's host-based firewall allows my endpoints to communicate with the Elastic Manager. Either the IP addresses, or the subnets that the devices exist on, need to be added to the firewall's allow-list. To add these exceptions, first log in to your Security Onion Console. On the left side, click the '<strong>Administration</strong>' tab, then click the '<strong>Configuration</strong>' sub-tab. From there, open the '<strong>firewall</strong>' drop-down &gt; '<strong>hostgroups</strong>' &gt; and finally click on the '<strong>elastic_agent_endpoint</strong>' settings. Here, you can enter the necessary IP addresses or network ranges in CIDR notation as shown in the screenshot below. Lastly, apply the new rules by clicking the green check-mark.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":414,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{site.baseurl}}/assets/0_host_firewall_allow-1024x494.png" alt="" class="wp-image-414"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>It is also important to make sure that any network-based firewalls that exist between the endpoints and the SO Manager allow communication between them. In my <a href="https://ihabeid.xyz/2024/05/12/designing-and-building-my-homelab/">homelab (see link)</a>, for example, my Security Onion and Active Directory labs are connected on different subnets, and are separated by my Pfsense firewall. Therefore, I needed to create allow-rules that accepted connections to the three port numbers listed below from the networks I wanted to monitor. (See screenshot below).</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Required Port Numbers:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul class="wp-block-list">
<!-- wp:list-item --></p>
<li>8220 TCP - Elastic Agent Management</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>8443 TCP - Elastic Agent Updates</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>5055 TCP - Elastic Agent Data</li>
<p><!-- /wp:list-item -->
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:image {"id":416,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{site.baseurl}}/assets/0_pfsense_rules-1024x402.png" alt="" class="wp-image-416"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4 class="wp-block-heading">Installing Agents</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>After making sure they were able to connect back to the manager, installing the Elastic Agents was simple. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Log in to your Security Onion Console. On the left side there is a section of links named 'Tools'. Click on the "Elastic Fleet" link and it will open a new tab to Security Onion's Fleet management page.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":417,"sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full"><img src="{{site.baseurl}}/assets/0_elastic_fleet_tab-1.png" alt="" class="wp-image-417"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>Click the "Add agent" button located in the "Agents" page.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":406,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{site.baseurl}}/assets/0_fleet_dash-1024x389.png" alt="" class="wp-image-406"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>In the pop-up window, select the "endpoints-initial" agent policy, then select the "Enroll in Fleet" option.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":404,"width":"840px","height":"auto","sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full is-resized"><img src="{{site.baseurl}}/assets/1_enrollnewagent.png" alt="" class="wp-image-404" style="width:840px;height:auto"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>Now you can select which operating system you need the agent installed on. Copy the commands and move over to the endpoint.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":403,"width":"840px","height":"auto","sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full is-resized"><img src="{{site.baseurl}}/assets/1_copy_command.png" alt="" class="wp-image-403" style="width:840px;height:auto"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>If your endpoint is Windows, open a PowerShell window as 'Administrator'. If it is Linux, it would be a Bash shell. Finally, enter in the commands.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Note</strong>: You will not have Security Onion's certificate signed in your environment by default. I had to add the option '<strong>--insecure</strong>' at the end of the last command for it to work. Otherwise, it would not accept the unsigned certificate.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":409,"sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full"><img src="{{site.baseurl}}/assets/1_installed_agent_blu.png" alt="" class="wp-image-409"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>If everything works correctly, you should get a "Successfully enrolled the Elastic Agent" message after the last command. On the Elastic Fleet dashboard, the agents will show up with an "Updating" status and eventually a "Healthy" status as shown below.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":408,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{site.baseurl}}/assets/4_updated_fleet-1024x579.png" alt="" class="wp-image-408"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 class="wp-block-heading">Installing Sysmon</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 class="wp-block-heading">Creating a New Detection</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
